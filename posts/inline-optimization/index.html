<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><link rel=icon href=/logo.png type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:url" content="https://bobblelaw.github.io/posts/inline-optimization/"><meta property="og:site_name" content="Bobble Law"><meta property="og:title" content="Inlining Optimization"><meta property="og:description" content="Even without inlining, the compiler does not always has to assume the worst case."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-19T17:29:41+08:00"><meta property="article:modified_time" content="2022-11-20T22:52:56+08:00"><meta property="article:tag" content="C++"><meta name=twitter:card content="summary"><meta name=twitter:title content="Inlining Optimization"><meta name=twitter:description content="Even without inlining, the compiler does not always has to assume the worst case."><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--text-link-color:#007bff;--background-color:#eaedf0;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--text-link-color-dark:#ffffff;--background-color-dark:#18191a;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{background-color:var(--background-color)!important}body::-webkit-scrollbar{height:0;width:8px;background-color:var(--background-color)}::-webkit-scrollbar-track{border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background:#b0b0b0;outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><meta name=description content="Even without inlining, the compiler does not always has to assume the worst case."><link rel=stylesheet href=/css/single.css><script defer src=/fontawesome-6/all-6.4.2.js></script><title>Inlining Optimization | Bobble Law</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme"),mediaQuery=window.matchMedia("(prefers-color-scheme: dark)").matches;switch(localStorageValue){case"dark":document.body.classList.add("dark");break;case"light":document.body.classList.remove("dark");break;default:mediaQuery&&document.body.classList.add("dark");break}</script><script>var prevScrollPos=window.pageYOffset;window.addEventListener("scroll",function(){let s=document.getElementById("profileHeader"),t=window.pageYOffset,n=!1,o=!0,i=o?prevScrollPos>t:t>0;i?s.classList.add("showHeaderOnTop"):n=!0,t===0&&(n=!0),n&&s.classList.remove("showHeaderOnTop"),prevScrollPos=t})</script><header id=profileHeader><nav class="pt-3 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/logo.png width=30 height=30 class="d-inline-block align-top">
Bob Law</a><div><input id=search autocomplete=off class="form-control mr-sm-2 d-none d-md-block" placeholder=Search... aria-label=Search oninput=searchOnChange(event)></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text d-block d-md-none"><div class=nav-link><input id=search autocomplete=off class="form-control mr-sm-2" placeholder=Search... aria-label=Search oninput=searchOnChange(event)></div></li><li class="nav-item navbar-text"><a class=nav-link href=/#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#experience aria-label=experience>Experience</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#education aria-label=education>Education</a></li><li class="nav-item navbar-text"><a class=nav-link href=/posts title>Posts</a></li><li class="nav-item navbar-text"><a class=nav-link href=/tags title>Tags</a></li><li class="nav-item navbar-text"><a class=nav-link href=/topics title>Topics</a></li><li class="nav-item navbar-text"><div class=text-center><button id=theme-toggle><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Inlining Optimization</h1><div class=text-center>May 19, 191941
<span id=readingTime>min read</span></div></div><article class="page-content p-2"><p><a href=https://en.wikipedia.org/wiki/Inline_expansion>Inlining</a> is one of the most important compiler optimizations.<br>We can often write abstractions and thin wrapper functions without incurring any performance penalty, because the compiler will expand the method for us at call site.</p><p>If a function is not inlined, conventional wisdom says that the compiler has to assume that the method can modify any global state and change the memory behind any pointer or reference that might have &ldquo;escaped&rdquo;.</p><p>In this short post, I&rsquo;ll demonstrate exactly this effect.<br>Furthermore, we will see that even if a function is not inlined, as long as the implementation is visible, some optimizations are still performed and sometimes to great effect.</p><h1 id=example>Example</h1><p>Let us consider this simple <code>test</code> function,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// implemented in different TU or otherwise linked in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>int</span> n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span> n) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which results in the following <a href=https://godbolt.org/z/oE5ozq1b4>assembly</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>test(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span>)<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  push rbp
</span></span><span style=display:flex><span>  push rbx
</span></span><span style=display:flex><span>  push rax
</span></span><span style=display:flex><span>  mov rbx, rdi
</span></span><span style=display:flex><span>  mov edi, dword ptr [rdi] <span style=color:#75715e>// load n from memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  call foo(<span style=color:#66d9ef>int</span>)            <span style=color:#75715e>// call foo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  mov ebp, eax
</span></span><span style=display:flex><span>  mov edi, dword ptr [rbx] <span style=color:#75715e>// load n from memory _again_
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  call foo(<span style=color:#66d9ef>int</span>)            <span style=color:#75715e>// call foo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  add eax, ebp
</span></span><span style=display:flex><span>  add rsp, <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>  pop rbx
</span></span><span style=display:flex><span>  pop rbp
</span></span><span style=display:flex><span>  ret
</span></span></code></pre></div><p>Unsurprising, <code>foo</code> is called twice.<br>For all we know, it has important side effects that have to be executed twice.<br>Maybe a bit more subtle: <code>n</code> had to be reloaded from memory, because the first call to <code>foo</code> might have changed the memory.<br>(For example, <code>n</code> might be a reference to a global <code>int</code> that <code>foo</code> happens to increment.)</p><p>This is really the worst case for the compiler.<br>Nothing about the inner workings of <code>foo</code> is known.</p><p>On the other end of the spectrum, we have a small, known <code>foo</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>int</span> n)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> n;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span> n) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which results in the following <a href=https://godbolt.org/z/6T6qsd79x>assembly</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>test(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span>)<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  mov eax, dword ptr [rdi] <span style=color:#75715e>// load n from memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  imul eax, eax            <span style=color:#75715e>// tmp = n*n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  add eax, eax             <span style=color:#75715e>// return tmp + tmp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ret
</span></span></code></pre></div><p>Not only is the call to <code>foo</code> inlined, further optimizations made sure that <code>n * n</code> is not computed twice.</p><h1 id=to-inline-or-not-to-inline>To Inline or not to Inline</h1><p>If <code>foo</code> is part of a different TU, the compiler can obviously not inline the call.<br>Should you have enough patience, <a href=https://en.wikipedia.org/wiki/Interprocedural_optimization>link-time optimization</a> might come to the rescue.<br>(It&rsquo;s usually really expensive, so I can only really recommend it for CI building release versions.)</p><p>However, there are many other reasons why <code>foo</code> is not inlined.<br>In general, inlining is a double-edged sword.<br>Each inlined function increases the pressure on the <a href=https://en.wikipedia.org/wiki/CPU_cache>instruction cache</a> and makes the parent function harder to analyze.<br>More local variables mean more <a href=https://en.wikipedia.org/wiki/Register_allocation>register spills</a>.<br>All these can negatively affect performance and compilers have various heuristic to try to make good decisions.</p><p>Most small functions will get inlined by default.<br>As the complexity of the function body rises, this will stop at some point.<br>Recursion <em>usually</em> prevents inlining, though <a href=https://godbolt.org/z/Ehdqcq37c>compilers are definitely able to inline recursive functions</a> via <a href=https://en.wikipedia.org/wiki/Tail_call>tail-call elimination</a>.</p><p>We can artificially prevent inlining by declaring the function <code>__declspec(noinline)</code> (for msvc) or <code>__attribute__((noinline))</code> (for gcc/clang):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>__attribute__((noinline)) <span style=color:#66d9ef>int</span> foo(<span style=color:#66d9ef>int</span> n)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> n;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span> n) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which results in the following <a href=https://godbolt.org/z/v5bPd99bo>assembly</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>test(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span>)<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  mov edi, dword ptr [rdi] <span style=color:#75715e>// load n from memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  call foo(<span style=color:#66d9ef>int</span>)            <span style=color:#75715e>// tmp = foo(n)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  add eax, eax             <span style=color:#75715e>// return tmp + tmp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ret
</span></span></code></pre></div><p>So, obviously <code>foo</code> was not inlined.<br>However, the compiler could still see and analyze it.<br>It came to the conclusion that <code>foo</code> does not read or modify global state.<br><code>foo</code> was flagged as a <a href=https://en.wikipedia.org/wiki/Pure_function>pure function</a>.</p><p>Pure functions are nice.<br>Pure functions return the same result if given the same input.<br>Pure functions do not modify global state, they work solely on their input values.<br>Thus, <code>foo(n) + foo(n)</code> was simplified to <code>tmp = foo(n); tmp + tmp</code>, even without inlining.</p><h1 id=fun-with-loops>Fun with Loops</h1><p>The difference becomes even larger with loops:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// different TU
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>int</span> n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span> n) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> n; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>        sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which results in the following <a href=https://godbolt.org/z/4ErEvzecE>assembly</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>test(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span>)<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  push rbp
</span></span><span style=display:flex><span>  push r14
</span></span><span style=display:flex><span>  push rbx
</span></span><span style=display:flex><span>  mov r14, rdi
</span></span><span style=display:flex><span>  mov edi, dword ptr [rdi]
</span></span><span style=display:flex><span>  xor ebp, ebp
</span></span><span style=display:flex><span>  test edi, edi <span style=color:#75715e>// n &lt; 0 case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  js .LBB0_3
</span></span><span style=display:flex><span>  mov ebx, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>.LBB0_2:         <span style=color:#75715e>// loop body begin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  call foo(<span style=color:#66d9ef>int</span>)            <span style=color:#75715e>// call foo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  add ebp, eax
</span></span><span style=display:flex><span>  mov edi, dword ptr [r14] <span style=color:#75715e>// reload n from memory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  inc ebx
</span></span><span style=display:flex><span>  cmp ebx, edi
</span></span><span style=display:flex><span>  jl .LBB0_2     <span style=color:#75715e>// loop body end
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>.LBB0_3:
</span></span><span style=display:flex><span>  mov eax, ebp
</span></span><span style=display:flex><span>  pop rbx
</span></span><span style=display:flex><span>  pop r14
</span></span><span style=display:flex><span>  pop rbp
</span></span><span style=display:flex><span>  ret
</span></span></code></pre></div><p>With no information, the compiler has to call <code>foo</code> (and load <code>n</code> from memory) in each iteration.<br>Contrast this with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>__attribute__((noinline)) <span style=color:#66d9ef>int</span> foo(<span style=color:#66d9ef>int</span> n)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> n <span style=color:#f92672>*</span> n;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>test</span>(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span> n) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>auto</span> sum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>auto</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;=</span> n; <span style=color:#f92672>++</span>i)
</span></span><span style=display:flex><span>        sum <span style=color:#f92672>+=</span> foo(n);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sum;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>which results in the following <a href=https://godbolt.org/z/96Mxvsv9b>assembly</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>test(<span style=color:#66d9ef>int</span> <span style=color:#66d9ef>const</span><span style=color:#f92672>&amp;</span>)<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>  mov edx, dword ptr [rdi]
</span></span><span style=display:flex><span>  test edx, edx
</span></span><span style=display:flex><span>  js .L5 <span style=color:#75715e>// special case n &lt; 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  mov edi, edx
</span></span><span style=display:flex><span>  call foo(<span style=color:#66d9ef>int</span>)  <span style=color:#75715e>// tmp1 = foo(n)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  imul edx, eax  <span style=color:#75715e>// tmp2 = tmp1 * n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  add eax, edx   <span style=color:#75715e>// return tmp2 + n
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ret
</span></span><span style=display:flex><span>.L5:
</span></span><span style=display:flex><span>  xor eax, eax <span style=color:#75715e>// return 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ret
</span></span></code></pre></div><p>So gcc is able to optimize the whole thing to basically <code>foo(n) * (n + 1)</code>, without inlining.<br>Funnily enough, clang tries (and fails) to be clever with lots of SIMD.</p><h1 id=conclusion>Conclusion</h1><p>This is not a long post, but it shows that while inlining is a very important optimization, a non-inlined function is not the end of <del>the world</del> optimization.<br>As long as the function implementation is visible, compilers can and will analyze them so that they don&rsquo;t have to assume the worst case.<br>This, in turn, re-enables many optimizations such as <a href=https://en.wikipedia.org/wiki/Value_numbering>value numbering</a>, <a href=https://en.wikipedia.org/wiki/Common_subexpression_elimination>common subexpression elimination</a>, and <a href=https://en.wikipedia.org/wiki/Loop-invariant_code_motion>loop-invariant code motion</a>.</p><p>PS: gcc and clang have a variety of <a href=https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html>function attributes</a> that can be used to enable optimizations, even if the implementation is in a different TU.<br>The two most important ones are <code>__attribute__((const))</code> and <code>__attribute__((pure))</code>.</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div id=stickySideBar class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=https://bobblelaw.github.io/tags/c++ target=_blank>C++</a></li></ul></aside><aside class=social><h5>Social</h5><div class=social-content><ul class=list-inline><li class="list-inline-item text-center"><a target=_blank href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbobblelaw.github.io%2fposts%2finline-optimization%2f"><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://twitter.com/share?text=Inlining%20Optimization&url=https%3a%2f%2fbobblelaw.github.io%2fposts%2finline-optimization%2f"><i class="fab fa-twitter"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://api.whatsapp.com/send?text=Inlining%20Optimization: https%3a%2f%2fbobblelaw.github.io%2fposts%2finline-optimization%2f"><i class="fab fa-whatsapp"></i></a></li><li class="list-inline-item text-center"><a target=_blank href='mailto:?subject=Inlining%20Optimization&amp;body=Check%20out%20this%20site https%3a%2f%2fbobblelaw.github.io%2fposts%2finline-optimization%2f'><i class="fa fa-envelope"></i></a></li></ul></div></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><div class=progress><div id=scroll-progress-bar class=progress-bar role=progressbar aria-valuenow=0 aria-valuemin=0 aria-valuemax=100></div></div><script src=/js/scrollProgressBar.js></script><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}let stickySideBarElem=document.getElementById("stickySideBar"),stickyNavBar=!0;if(stickyNavBar){let e=document.getElementById("profileHeader"),t=e.offsetHeight+15;stickySideBarElem.style.top=t+"px"}else stickySideBarElem.style.top="50px"</script><script src=/js/readingTime.js></script></div><footer><div class="text-center pt-2"><span class=px-1><a href=https://github.com/BobbleLaw aria-label=github><svg width="2.7em" height="2.7em" viewBox="0 0 1792 1792"><path id="footer-socialNetworks-github-svg-path" d="M522 1352q-8 9-20-3-13-11-4-19 8-9 20 3 12 11 4 19zm-42-61q9 12 0 19-8 6-17-7t0-18q9-7 17 6zm-61-60q-5 7-13 2-10-5-7-12 3-5 13-2 10 5 7 12zm31 34q-6 7-16-3-9-11-2-16 6-6 16 3 9 11 2 16zm129 112q-4 12-19 6-17-4-13-15t19-7q16 5 13 16zm63 5q0 11-16 11-17 2-17-11 0-11 16-11 17-2 17 11zm58-10q2 10-14 14t-18-8 14-15q16-2 18 9zm964-956v960q0 119-84.5 203.5T1376 1664h-224q-16 0-24.5-1t-19.5-5-16-14.5-5-27.5v-239q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 492 446q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 103t.5 68q0 22-11 33.5t-22 13-33 1.5H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg>
</a></span><span class=px-1><a href=https://www.linkedin.com/in/boblzy aria-label=linkedin><svg width="2.4em" height="2.4em" fill="#fff" aria-label="LinkedIn" viewBox="0 0 512 512"><rect width="512" height="512" fill="#0077b5" rx="15%"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg></a></span></div><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center"><div class=pb-2><a href=https://bobblelaw.github.io/ title="Bobble Law"><img alt="Footer logo" src=/logo.png height=40px width=40px></a></div>&copy; 2025 All rights reserved<div class=text-secondary>Made with
<span class=text-danger>&#10084;
</span>and
<a href=https://github.com/gurusabarish/hugo-profile target=_blank title="Designed and developed by gurusabarish">Hugo Profile</a></div></div></div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map(function(e){return new bootstrap.Tooltip(e)})</script><script src=/js/search.js></script><section id=search-content class=py-2><div class=container id=search-results></div></section></body></html>